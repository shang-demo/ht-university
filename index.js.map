{"version":3,"sources":["webpack://ht-university/external \"os\"","webpack://ht-university/webpack/bootstrap","webpack://ht-university/webpack/runtime/compat get default export","webpack://ht-university/webpack/runtime/define property getters","webpack://ht-university/webpack/runtime/hasOwnProperty shorthand","webpack://ht-university/external \"promise-retry\"","webpack://ht-university/external \"path\"","webpack://ht-university/external \"puppeteer-core\"","webpack://ht-university/./src/common/error.ts","webpack://ht-university/external \"fs-extra\"","webpack://ht-university/external \"child_process\"","webpack://ht-university/./src/ui/puppeteer/findChrome.ts","webpack://ht-university/./src/ui/puppeteer/global-browser.ts","webpack://ht-university/./src/index.ts"],"names":["module","exports","require","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","n","getter","__esModule","d","a","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","ERROR_MAP","OperationalError","Error","constructor","extra","message","code","super","this","toJSON","type","stack","toString","JSON","stringify","Errors","keys","reduce","result","defaultMessage","buildErrors","newLineRegex","canAccess","file","fs","e","darwin","canary","grepexpr","paths","execSync","split","filter","map","trim","unshift","p","startsWith","inst","path","linux","installations","forEach","folder","concat","argumentsRegex","chromeExecRegex","execPaths","execPath","replace","push","findChromeExecutables","executable","chromePath","execFileSync","stdio","length","priorities","regex","weight","process","env","CHROME_PATH","RegExp","pair","test","sort","b","arr","Boolean","Array","from","Set","win32","suffix","LOCALAPPDATA","PROGRAMFILES","prefix","globalBrowser","async","getBrowser","localChrome","options","executablePath","config","channel","has","platform","findChrome","LocalChromeNotFound","args","puppeteer","headless","defaultViewport","pipe","userDataDir","resolve","__dirname","retryPlayVideo","browser","url","promiseRetry","retry","number","console","log","page","newPage","goto","waitUntil","$eval","ele","Promise","reject","setTimeout","addEventListener","once","close","play","muted","playVideo","catch","username","password","argv","slice","waitForSelector","delay","all","waitForNavigation","timeout","click","login","list","doc","content","v","match","$$eval","querySelector","percent","innerText","parseInt","outerHTML","getStudyPages","item","retries","warn"],"mappings":"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","file":"index.js","sourcesContent":["module.exports = require(\"os\");;","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"promise-retry\");;","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"path\");;","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"puppeteer-core\");;","/* eslint-disable max-classes-per-file */\r\n\r\nexport enum ERROR_MAP {\r\n  OperationalError = 'OperationalError',\r\n  SpawnError = 'spawn error',\r\n  Timeout = 'Timeout',\r\n  Unknown = 'Unknown',\r\n\r\n  ParamsRequired = '参数缺少',\r\n\r\n  InjectNoPlatform = '未选择平台',\r\n  InjectNoServiceName = '没有找到 service 文件',\r\n  InjectNoModelName = '没有找到 model 文件',\r\n  InjectDuplicated = '检测到相同字段',\r\n  PathNotFound = '路径未找到',\r\n  PathIsNotDirectory = '路径不是文件夹',\r\n  LocalChromeNotFound = '本机Chrome未找到',\r\n}\r\nexport interface ErrorJSON {\r\n  type: 'error';\r\n  message: string;\r\n  code: keyof typeof ERROR_MAP;\r\n  extra?: any;\r\n  stack?: string;\r\n}\r\n\r\nexport class OperationalError extends Error {\r\n  private extra: any;\r\n\r\n  private code: keyof typeof ERROR_MAP;\r\n\r\n  constructor(\r\n    extra?: Record<string, any>,\r\n    message?: string,\r\n    code: keyof typeof ERROR_MAP = 'OperationalError'\r\n  ) {\r\n    super();\r\n\r\n    this.code = code;\r\n    this.message = message || 'OperationalError';\r\n    this.extra = extra;\r\n  }\r\n\r\n  public toJSON(): ErrorJSON {\r\n    return {\r\n      type: 'error',\r\n      message: this.message,\r\n      code: this.code,\r\n      extra: this.extra,\r\n      stack: this.stack,\r\n    };\r\n  }\r\n\r\n  public toString(): string {\r\n    return `${this.code}\r\n${this.extra ? JSON.stringify(this.extra) : ''}\r\n${this.stack || ''}`;\r\n  }\r\n}\r\n\r\nexport type ERRORS = {\r\n  [name in keyof typeof ERROR_MAP]: typeof OperationalError;\r\n};\r\n\r\nfunction buildErrors(): ERRORS {\r\n  const keys = Object.keys(ERROR_MAP) as [keyof typeof ERROR_MAP];\r\n  const o = keys.reduce((result, code) => {\r\n    const defaultMessage = ERROR_MAP[code];\r\n\r\n    class ChildError extends OperationalError {\r\n      constructor(extra?: Record<string, any>, message?: string) {\r\n        super(extra, message || defaultMessage, code);\r\n      }\r\n    }\r\n\r\n    // eslint-disable-next-line no-param-reassign\r\n    result[code] = ChildError;\r\n    return result;\r\n  }, {} as any);\r\n\r\n  o.OperationalError = OperationalError;\r\n  return o;\r\n}\r\n\r\nconst Errors = buildErrors();\r\n\r\nfunction isErrorLike(obj: any): obj is ErrorJSON {\r\n  return !!(obj && obj.type === 'error' && obj.code);\r\n}\r\n\r\nfunction try2error<T>(obj: T): OperationalError | T {\r\n  if (isErrorLike(obj)) {\r\n    const code = obj.code as keyof typeof ERROR_MAP;\r\n    if (Errors[code]) {\r\n      return new Errors[code](obj.extra, obj.message);\r\n    }\r\n\r\n    return new Errors.Unknown(obj, obj.message);\r\n  }\r\n\r\n  return obj;\r\n}\r\n\r\nexport { Errors, try2error };\r\n","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"fs-extra\");;","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"child_process\");;","/* eslint-disable global-require */\r\n/* eslint-disable @typescript-eslint/no-var-requires */\r\n/* eslint-disable no-continue */\r\n/* eslint-disable no-restricted-syntax */\r\n\r\n// https://github.com/GoogleChromeLabs/carlo/blob/master/lib/find_chrome.js\r\n\r\nimport fs from 'fs-extra';\r\nimport path from 'path';\r\nimport { execSync, execFileSync } from 'child_process';\r\n\r\nconst newLineRegex = /\\r?\\n/;\r\n\r\nfunction sort(\r\n  installations: string[],\r\n  priorities: {\r\n    regex: RegExp;\r\n    weight: number;\r\n  }[],\r\n) {\r\n  const defaultPriority = 10;\r\n  return (\r\n    installations\r\n      // assign priorities\r\n      .map((inst) => {\r\n        for (const pair of priorities) {\r\n          if (pair.regex.test(inst)) return { path: inst, weight: pair.weight };\r\n        }\r\n        return { path: inst, weight: defaultPriority };\r\n      })\r\n      // sort based on priorities\r\n      .sort((a, b) => b.weight - a.weight)\r\n      // remove priority flag\r\n      .map((pair) => pair.path)\r\n  );\r\n}\r\n\r\nfunction uniq(arr: string[]) {\r\n  return Array.from(new Set(arr));\r\n}\r\n\r\nfunction canAccess(file: string) {\r\n  if (!file) {\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    fs.accessSync(file);\r\n    return true;\r\n  } catch (e) {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction findChromeExecutables(folder: string) {\r\n  const argumentsRegex = /(^[^ ]+).*/; // Take everything up to the first space\r\n  const chromeExecRegex = '^Exec=/.*/(google-chrome|chrome|chromium)-.*';\r\n\r\n  const installations: string[] = [];\r\n  if (canAccess(folder)) {\r\n    // Output of the grep & print looks like:\r\n    //    /opt/google/chrome/google-chrome --profile-directory\r\n    //    /home/user/Downloads/chrome-linux/chrome-wrapper %U\r\n    let execPaths;\r\n\r\n    // Some systems do not support grep -R so fallback to -r.\r\n    // See https://github.com/GoogleChrome/chrome-launcher/issues/46 for more context.\r\n    try {\r\n      execPaths = execSync(`grep -ER \"${chromeExecRegex}\" ${folder} | awk -F '=' '{print $2}'`);\r\n    } catch (e) {\r\n      execPaths = execSync(`grep -Er \"${chromeExecRegex}\" ${folder} | awk -F '=' '{print $2}'`);\r\n    }\r\n\r\n    execPaths = execPaths\r\n      .toString()\r\n      .split(newLineRegex)\r\n      .map((execPath) => execPath.replace(argumentsRegex, '$1'));\r\n\r\n    execPaths.forEach((execPath) => canAccess(execPath) && installations.push(execPath));\r\n  }\r\n\r\n  return installations;\r\n}\r\n\r\nfunction darwin(canary?: boolean) {\r\n  const LSREGISTER =\r\n    '/System/Library/Frameworks/CoreServices.framework' +\r\n    '/Versions/A/Frameworks/LaunchServices.framework' +\r\n    '/Versions/A/Support/lsregister';\r\n  const grepexpr = canary ? 'google chrome canary' : 'google chrome';\r\n  const result = execSync(\r\n    `${LSREGISTER} -dump  | grep -i '${grepexpr}\\\\?.app$' | awk '{$1=\"\"; print $0}'`,\r\n  );\r\n\r\n  const paths = result\r\n    .toString()\r\n    .split(newLineRegex)\r\n    .filter((a) => a)\r\n    .map((a) => a.trim());\r\n  paths.unshift(\r\n    canary ? '/Applications/Google Chrome Canary.app' : '/Applications/Google Chrome.app',\r\n  );\r\n\r\n  for (const p of paths) {\r\n    if (p.startsWith('/Volumes')) {\r\n      continue;\r\n    }\r\n    const inst = path.join(\r\n      p,\r\n      canary ? '/Contents/MacOS/Google Chrome Canary' : '/Contents/MacOS/Google Chrome',\r\n    );\r\n    if (canAccess(inst)) return inst;\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Look for linux executables in 3 ways\r\n * 1. Look into CHROME_PATH env variable\r\n * 2. Look into the directories where .desktop are saved on gnome based distro's\r\n * 3. Look for google-chrome-stable & google-chrome executables by using the which command\r\n */\r\nfunction linux() {\r\n  let installations: string[] = [];\r\n\r\n  // Look into the directories where .desktop are saved on gnome based distro's\r\n  const desktopInstallationFolders = [\r\n    path.join(require('os').homedir(), '.local/share/applications/'),\r\n    '/usr/share/applications/',\r\n  ];\r\n  desktopInstallationFolders.forEach((folder) => {\r\n    installations = installations.concat(findChromeExecutables(folder));\r\n  });\r\n\r\n  // Look for google-chrome(-stable) & chromium(-browser) executables by using the which command\r\n  const executables = ['google-chrome-stable', 'google-chrome', 'chromium-browser', 'chromium'];\r\n  executables.forEach((executable) => {\r\n    try {\r\n      const chromePath = execFileSync('which', [executable], { stdio: 'pipe' })\r\n        .toString()\r\n        .split(newLineRegex)[0];\r\n      if (canAccess(chromePath)) installations.push(chromePath);\r\n    } catch (e) {\r\n      // Not installed.\r\n    }\r\n  });\r\n\r\n  if (!installations.length)\r\n    throw new Error(\r\n      'The environment variable CHROME_PATH must be set to executable of a build of Chromium version 54.0 or later.',\r\n    );\r\n\r\n  const priorities = [\r\n    { regex: /chrome-wrapper$/, weight: 51 },\r\n    { regex: /google-chrome-stable$/, weight: 50 },\r\n    { regex: /google-chrome$/, weight: 49 },\r\n    { regex: /chromium-browser$/, weight: 48 },\r\n    { regex: /chromium$/, weight: 47 },\r\n  ];\r\n\r\n  if (process.env.CHROME_PATH)\r\n    priorities.unshift({\r\n      regex: new RegExp(`${process.env.CHROME_PATH}`),\r\n      weight: 101,\r\n    });\r\n\r\n  return sort(uniq(installations.filter(Boolean)), priorities)[0];\r\n}\r\n\r\nfunction win32(canary?: boolean) {\r\n  const suffix = canary\r\n    ? `${path.sep}Google${path.sep}Chrome SxS${path.sep}Application${path.sep}chrome.exe`\r\n    : `${path.sep}Google${path.sep}Chrome${path.sep}Application${path.sep}chrome.exe`;\r\n  const prefixes = [\r\n    process.env.LOCALAPPDATA,\r\n    process.env.PROGRAMFILES,\r\n    process.env['PROGRAMFILES(X86)'],\r\n  ].filter(Boolean) as string[];\r\n\r\n  let result;\r\n  prefixes.forEach((prefix) => {\r\n    const chromePath = path.join(prefix, suffix);\r\n    if (canAccess(chromePath)) result = chromePath;\r\n  });\r\n  return result;\r\n}\r\n\r\ninterface FindResult {\r\n  executablePath: string;\r\n  type: 'user' | 'canary' | 'stable';\r\n}\r\n\r\nfunction findChrome(\r\n  options: {\r\n    executablePath?: string;\r\n    channel?: string;\r\n  } = {},\r\n): FindResult | undefined {\r\n  if (options.executablePath) return { executablePath: options.executablePath, type: 'user' };\r\n\r\n  const config = new Set(options.channel || ['stable']);\r\n  let executablePath;\r\n  // Always prefer canary.\r\n  if (config.has('canary') || config.has('*')) {\r\n    if (process.platform === 'linux') {\r\n      executablePath = linux();\r\n    } else if (process.platform === 'win32') {\r\n      executablePath = win32(true);\r\n    } else if (process.platform === 'darwin') {\r\n      executablePath = darwin(true);\r\n    }\r\n\r\n    if (executablePath) {\r\n      return { executablePath, type: 'canary' };\r\n    }\r\n  }\r\n\r\n  // Then pick stable.\r\n  if (config.has('stable') || config.has('*')) {\r\n    if (process.platform === 'linux') {\r\n      executablePath = linux();\r\n    } else if (process.platform === 'win32') {\r\n      executablePath = win32();\r\n    } else if (process.platform === 'darwin') {\r\n      executablePath = darwin();\r\n    }\r\n    if (executablePath) {\r\n      return { executablePath, type: 'stable' };\r\n    }\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nexport { findChrome };\r\n","import { resolve } from 'path';\r\nimport puppeteer, { Browser } from 'puppeteer-core';\r\nimport { Errors } from '../../common/error';\r\nimport { findChrome } from './findChrome';\r\n\r\nlet globalBrowser: Promise<Browser> | undefined;\r\nasync function getBrowser(): Promise<puppeteer.Browser> {\r\n  if (!globalBrowser) {\r\n    const localChrome = findChrome();\r\n\r\n    if (!localChrome) {\r\n      throw new Errors.LocalChromeNotFound();\r\n    }\r\n\r\n    const args = ['--app=data:text/html,', '--window-size=1000,600', '--window-position=150,60'];\r\n\r\n    globalBrowser = puppeteer.launch({\r\n      args,\r\n      executablePath: localChrome.executablePath,\r\n      headless: true,\r\n      defaultViewport: null,\r\n      pipe: true,\r\n      userDataDir: resolve(__dirname, '../../../.local-data/profile'),\r\n    });\r\n  }\r\n\r\n  return globalBrowser;\r\n}\r\n\r\nasync function getEndpoint(): Promise<string> {\r\n  const browser = await getBrowser();\r\n  return browser.wsEndpoint();\r\n}\r\n\r\nasync function clean(): Promise<{\r\n  len: number;\r\n}> {\r\n  if (!globalBrowser) {\r\n    return { len: 0 };\r\n  }\r\n\r\n  const browser = await globalBrowser;\r\n  globalBrowser = undefined;\r\n\r\n  const pages = await browser.pages();\r\n  await browser.close();\r\n\r\n  return {\r\n    len: pages.length,\r\n  };\r\n}\r\n\r\nexport { getEndpoint, clean, getBrowser };\r\n","import promiseRetry from 'promise-retry';\r\nimport type { Browser, Page } from 'puppeteer-core';\r\nimport { getBrowser } from './ui/puppeteer/global-browser';\r\n\r\nconst studyUrl = `http://university.hengtonggroup.com.cn/sty/mystudytask.htm`;\r\n\r\nasync function login(username: string | undefined, password: string | undefined, page: Page) {\r\n  if (!username) {\r\n    throw new Error('请输入用户名');\r\n  }\r\n\r\n  if (!password) {\r\n    throw new Error('请输入密码');\r\n  }\r\n\r\n  console.log('登录账户为: ', { username, password });\r\n\r\n  await page.goto(`http://university.hengtonggroup.com.cn/login.htm`, {\r\n    waitUntil: 'networkidle2',\r\n  });\r\n\r\n  await page.waitForSelector('#txtUserName2');\r\n  await page.type('#txtUserName2', username, { delay: 100 });\r\n  await page.type('#txtPassword2', password, { delay: 100 });\r\n\r\n  console.log('登录中....');\r\n  await Promise.all([\r\n    page.waitForNavigation({ timeout: 30 * 1000, waitUntil: 'networkidle2' }),\r\n    await page.$eval('#btnLogin2', (ele) => {\r\n      (ele as HTMLButtonElement).click();\r\n    }),\r\n  ]);\r\n\r\n  return page;\r\n}\r\n\r\nasync function getStudyPages(page: Page) {\r\n  await page.goto(studyUrl, { waitUntil: 'networkidle2' });\r\n\r\n  const doc = await page.content();\r\n\r\n  const [v] = doc.match(/(?<=learningKnowledge\\((&quot;|\"))(.*?\\.html)/g) ?? [];\r\n\r\n  await page.goto(`http://university.hengtonggroup.com.cn/${v}`, { waitUntil: 'networkidle2' });\r\n\r\n  const urlList = await page.$$eval('#tbodyTrainInfo .hand', (list) => {\r\n    return list\r\n      .filter((v) => {\r\n        let ele = v.querySelector<HTMLTableCellElement>('td:last-of-type');\r\n\r\n        if (!ele) {\r\n          return false;\r\n        }\r\n\r\n        const [percent] = ele.innerText.match(/\\d+(?=%)/) ?? [];\r\n\r\n        if (!percent) {\r\n          return false;\r\n        }\r\n\r\n        if (parseInt(percent, 10) === 100) {\r\n          return false;\r\n        }\r\n\r\n        return true;\r\n      })\r\n      .map((ele) => {\r\n        const [path] = ele.outerHTML.match(/(?<=StudyRowClick\\((&quot;|\"|'))(.*?\\.html)/g) ?? [];\r\n\r\n        return path;\r\n      });\r\n  });\r\n\r\n  return urlList;\r\n}\r\n\r\nasync function playVideo(browser: Browser, url: string) {\r\n  const page = await browser.newPage();\r\n  await page.goto(`http://university.hengtonggroup.com.cn/${url}`, { waitUntil: 'networkidle2' });\r\n\r\n  await page.$eval('video', (e) => {\r\n    let ele = e as HTMLVideoElement;\r\n    return new Promise((resolve, reject) => {\r\n      // 超时\r\n      setTimeout(() => {\r\n        reject(new Error('time out'));\r\n      }, 30 * 1000);\r\n\r\n      // 成功播放\r\n      ele.addEventListener(\r\n        'playing',\r\n        () => {\r\n          setTimeout(resolve, 3 * 1000);\r\n        },\r\n        { once: true },\r\n      );\r\n\r\n      // 播放结束\r\n      ele.addEventListener(\r\n        'ended',\r\n        () => {\r\n          setTimeout(() => {\r\n            page.close();\r\n          }, 3 * 1000);\r\n        },\r\n        { once: true },\r\n      );\r\n\r\n      ele.play();\r\n      ele.muted = true;\r\n    });\r\n  });\r\n}\r\n\r\nasync function retryPlayVideo(browser: Browser, url: string, options: Record<string, any>) {\r\n  return promiseRetry((retry, number) => {\r\n    console.log('attempt number', number);\r\n\r\n    return playVideo(browser, url).catch(retry);\r\n  }, options);\r\n}\r\n\r\n(async () => {\r\n  console.log('启动浏览器中.....');\r\n  const browser = await getBrowser();\r\n  const page = await browser.newPage();\r\n\r\n  const [username, password] = process.argv.slice(2);\r\n  await login(username, password, page);\r\n  const list = await getStudyPages(page);\r\n\r\n  console.log('正在打开网页做任务~, 共有任务: ', list.length);\r\n  for (const item of list) {\r\n    await retryPlayVideo(browser, item, { retries: 3 });\r\n  }\r\n\r\n  console.log('执行中, 没有结束判断, 等半小时自己 ctrl+c 关闭吧');\r\n})().catch(console.warn);\r\n"],"sourceRoot":""}